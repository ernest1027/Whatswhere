<!DOCTYPE html>
<html>
  <head>
    <title>Place Searches</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCiHfol2cwmJELs70oalCgdg94syFcM4nc&callback=initMap&libraries=places&v=weekly"
      defer
    ></script>
    <style type="text/css">
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }

      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script>
      "use strict";

      // This example requires the Places library. Include the libraries=places
      // parameter when you first load the API. For example:
      // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">
      let map;
      let service;
      let infowindow;
      var initLoc;
      function initMap(location) {
       
        var loc1 = new google.maps.LatLng(43.6532,-79.3832);
        infowindow = new google.maps.InfoWindow();
        map = new google.maps.Map(document.getElementById("map"), {
          center: loc1,
          zoom: 15
          
        });
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            map.setCenter(pos);
            update();
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
            
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
          update();
        }
        // google.maps.event.addListener(map, 'bounds_changed', function () {
        //     
        //     if(true)(
        //       update()
        //     )    
        // });

      }
      function callback(results, status) {
        console.log(results);
        if (status == google.maps.places.PlacesServiceStatus.OK) {
            for (var i = 0; i < results.length; i++) {
            createMarker(results[i]);
            }
        }
      }
      
      function createMarker(place) {
        const marker = new google.maps.Marker({
          map,
          position: place.geometry.location
        });
        marker.addListener("click", () => {
          infowindow.setContent(place.name);
          infowindow.open(map);
        });
        return marker;
        
      }
      //google.maps.event.addDomListener(window, 'load', update);
      function update(){
        const request = {
            location: map.getCenter(),
            radius: '10000',
            type: ['supermarket']
        };
        console.log(request);
        service = new google.maps.places.PlacesService(map);
        service.nearbySearch(request, callback);
      }
      
      //google.maps.event.addDomListener(window, 'load', initMap);
    </script>
  </head>
  <body>
    <div id="map"></div>
  </body>
</html>